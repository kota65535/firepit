{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "ProjectConfig",
  "type": "object",
  "properties": {
    "concurrency": {
      "description": "Task concurrency.\nValid only in root project config.",
      "type": "integer",
      "format": "uint",
      "default": 4,
      "minimum": 0
    },
    "depends_on": {
      "description": "Dependency tasks for all tasks.",
      "type": "array",
      "default": [],
      "items": {
        "$ref": "#/$defs/DependsOnConfig"
      }
    },
    "env": {
      "description": "Environment variables for all tasks.",
      "type": "object",
      "additionalProperties": {
        "type": "string"
      },
      "default": {}
    },
    "env_files": {
      "description": "Dotenv files for all tasks.\nIf environment variable duplicates, the later one wins.",
      "type": "array",
      "default": [],
      "items": {
        "type": "string"
      }
    },
    "gantt_file": {
      "description": "Gantt chart output file path.",
      "type": [
        "string",
        "null"
      ]
    },
    "includes": {
      "description": "Additional config files to be included.",
      "type": "array",
      "default": [],
      "items": {
        "type": "string"
      }
    },
    "log": {
      "description": "Log configuration.\nValid only in root project config.",
      "$ref": "#/$defs/LogConfig",
      "default": {
        "file": null,
        "level": "info"
      }
    },
    "projects": {
      "description": "Child projects.\nValid only in root project config.",
      "type": "object",
      "additionalProperties": {
        "type": "string"
      },
      "default": {}
    },
    "shell": {
      "description": "Shell configuration for all tasks.",
      "$ref": "#/$defs/ShellConfig",
      "default": {
        "args": [
          "-c"
        ],
        "command": "bash"
      }
    },
    "tasks": {
      "description": "Task definitions",
      "type": "object",
      "additionalProperties": {
        "$ref": "#/$defs/TaskConfig"
      },
      "default": {}
    },
    "ui": {
      "description": "UI configuration.\nValid only in root project config.",
      "$ref": "#/$defs/UI",
      "default": "cui"
    },
    "vars": {
      "description": "Template variables.\nCan be used at `working_dir`, `env`, `env_files`, `depends_on`, `depends_on.{task, vars}` and `tasks`.",
      "type": "object",
      "additionalProperties": true,
      "default": {}
    },
    "working_dir": {
      "description": "Working directory for all tasks.",
      "type": "string",
      "default": "."
    }
  },
  "$defs": {
    "DependsOnConfig": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "$ref": "#/$defs/DependsOnConfigStruct"
        }
      ]
    },
    "DependsOnConfigStruct": {
      "type": "object",
      "properties": {
        "cascade": {
          "type": "boolean",
          "default": true
        },
        "task": {
          "type": "string"
        },
        "vars": {
          "type": "object",
          "additionalProperties": true,
          "default": {}
        }
      },
      "required": [
        "task"
      ]
    },
    "ExecProbeConfig": {
      "type": "object",
      "properties": {
        "command": {
          "description": "Command to run",
          "type": "string"
        },
        "env": {
          "description": "Environment variables.\nMerged with the task's env.",
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "default": {}
        },
        "env_files": {
          "description": "Dotenv files\nMerged with the task's env.",
          "type": "array",
          "default": [],
          "items": {
            "type": "string"
          }
        },
        "interval": {
          "type": "integer",
          "format": "uint64",
          "default": 5,
          "minimum": 0
        },
        "retries": {
          "type": "integer",
          "format": "uint64",
          "default": 3,
          "minimum": 0
        },
        "shell": {
          "description": "Shell configuration",
          "anyOf": [
            {
              "$ref": "#/$defs/ShellConfig"
            },
            {
              "type": "null"
            }
          ]
        },
        "start_period": {
          "type": "integer",
          "format": "uint64",
          "default": 0,
          "minimum": 0
        },
        "timeout": {
          "type": "integer",
          "format": "uint64",
          "default": 5,
          "minimum": 0
        },
        "working_dir": {
          "description": "Working directory",
          "type": [
            "string",
            "null"
          ]
        }
      },
      "required": [
        "command"
      ]
    },
    "HealthCheckConfig": {
      "anyOf": [
        {
          "$ref": "#/$defs/LogProbeConfig"
        },
        {
          "$ref": "#/$defs/ExecProbeConfig"
        }
      ]
    },
    "LogConfig": {
      "type": "object",
      "properties": {
        "file": {
          "description": "Log file path.",
          "type": [
            "string",
            "null"
          ]
        },
        "level": {
          "description": "Log level: error, warn, info, debug, trace",
          "type": "string",
          "default": "info"
        }
      }
    },
    "LogProbeConfig": {
      "type": "object",
      "properties": {
        "log": {
          "description": "Log regex pattern to determine the task service is ready",
          "type": "string"
        },
        "timeout": {
          "type": "integer",
          "format": "uint64",
          "default": 20,
          "minimum": 0
        }
      },
      "required": [
        "log"
      ]
    },
    "Restart": {
      "oneOf": [
        {
          "type": "string",
          "enum": [
            "Never"
          ]
        },
        {
          "type": "object",
          "properties": {
            "Always": {
              "type": [
                "integer",
                "null"
              ],
              "format": "uint64",
              "minimum": 0
            }
          },
          "additionalProperties": false,
          "required": [
            "Always"
          ]
        },
        {
          "type": "object",
          "properties": {
            "OnFailure": {
              "type": [
                "integer",
                "null"
              ],
              "format": "uint64",
              "minimum": 0
            }
          },
          "additionalProperties": false,
          "required": [
            "OnFailure"
          ]
        }
      ]
    },
    "ServiceConfig": {
      "anyOf": [
        {
          "type": "boolean"
        },
        {
          "$ref": "#/$defs/ServiceConfigStruct"
        }
      ]
    },
    "ServiceConfigStruct": {
      "type": "object",
      "properties": {
        "healthcheck": {
          "anyOf": [
            {
              "$ref": "#/$defs/HealthCheckConfig"
            },
            {
              "type": "null"
            }
          ]
        },
        "restart": {
          "$ref": "#/$defs/Restart",
          "default": "never"
        }
      }
    },
    "ShellConfig": {
      "type": "object",
      "properties": {
        "args": {
          "description": "Arguments of the shell command.",
          "type": "array",
          "default": [
            "-c"
          ],
          "items": {
            "type": "string"
          }
        },
        "command": {
          "description": "Shell command.",
          "type": "string",
          "default": "bash"
        }
      }
    },
    "TaskConfig": {
      "type": "object",
      "properties": {
        "command": {
          "description": "Command to run",
          "type": [
            "string",
            "null"
          ]
        },
        "depends_on": {
          "description": "Dependency task names",
          "type": "array",
          "default": [],
          "items": {
            "$ref": "#/$defs/DependsOnConfig"
          }
        },
        "env": {
          "description": "Environment variables.\nMerged with the project's env.",
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "default": {}
        },
        "env_files": {
          "description": "Dotenv files\nMerged with the project's env.",
          "type": "array",
          "default": [],
          "items": {
            "type": "string"
          }
        },
        "inputs": {
          "description": "Inputs file glob patterns",
          "type": "array",
          "default": [],
          "items": {
            "type": "string"
          }
        },
        "label": {
          "description": "Label for display",
          "type": [
            "string",
            "null"
          ]
        },
        "outputs": {
          "description": "Output file glob patterns",
          "type": "array",
          "default": [],
          "items": {
            "type": "string"
          }
        },
        "service": {
          "description": "Service configuration",
          "anyOf": [
            {
              "$ref": "#/$defs/ServiceConfig"
            },
            {
              "type": "null"
            }
          ]
        },
        "shell": {
          "description": "Shell configuration",
          "anyOf": [
            {
              "$ref": "#/$defs/ShellConfig"
            },
            {
              "type": "null"
            }
          ]
        },
        "vars": {
          "description": "Template variables.\nCan be used at `label`, `command`, `working_dir`, `env`, `env_files`, `depends_on`, `depends_on.{task, vars}`,\n`service.healthcheck.log` and `service.healthcheck.exec.{command, working_dir, env, env_files}`",
          "type": "object",
          "additionalProperties": true,
          "default": {}
        },
        "working_dir": {
          "description": "Working directory",
          "type": [
            "string",
            "null"
          ]
        }
      }
    },
    "UI": {
      "type": "string",
      "enum": [
        "cui",
        "tui"
      ]
    }
  }
}